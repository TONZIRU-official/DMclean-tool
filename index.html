<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Finger Balance - Catch & Hold</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Arial Black', sans-serif; }
        #input_video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); z-index: 0; }
        canvas { position: fixed; top: 0; left: 0; z-index: 1; pointer-events: none; }
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; }
        .stats { color: #fff; font-size: 32px; text-shadow: 0 0 10px #000, 0 0 5px #0f0; }
        #msg { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 60px; color: #fff; text-shadow: 0 0 20px #f00; text-align: center; }
        .guide { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); color: #fff; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; }
    </style>
</head>
<body>
    <video id="input_video" playsinline></video>
    <canvas id="canvas"></canvas>
    <div id="overlay">
        <div class="stats">SCORE: <span id="score">0</span></div>
        <div id="msg">READY...</div>
        <div class="guide">落ちてくる棒を指先で受け止めて！</div>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score');
        const msgDisplay = document.getElementById('msg');

        let width, height;
        let fingerX = 0, fingerY = 0, lastFingerX = 0;
        
        // 棒（オブジェクト）の状態
        let pole = {
            x: 0, y: -500, 
            angle: 0, angVel: 0,
            velY: 0, 
            isCaught: false,
            length: 300
        };

        let score = 0;
        let gameActive = true;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            resetPole();
        }
        window.addEventListener('resize', resize);
        resize();

        function resetPole() {
            pole.x = Math.random() * (width - 200) + 100;
            pole.y = -300;
            pole.angle = (Math.random() - 0.5) * 1.5; // ランダムな角度で落ちてくる
            pole.angVel = (Math.random() - 0.5) * 0.05;
            pole.velY = 3; // 落下速度
            pole.isCaught = false;
        }

        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7 });
        
        hands.onResults(results => {
            if (results.multiHandLandmarks?.length > 0) {
                const tip = results.multiHandLandmarks[0][8];
                fingerX = (1 - tip.x) * width;
                fingerY = tip.y * height;
                if (msgDisplay.innerText === "READY...") msgDisplay.innerText = "";
            }
        });

        const camera = new Camera(videoElement, {
            onFrame: async () => await hands.send({image: videoElement}),
            width: 1280, height: 720
        });
        camera.start();

        function draw() {
            ctx.clearRect(0, 0, width, height);

            if (gameActive) {
                // 指と棒の当たり判定
                let dist = Math.hypot(fingerX - pole.x, fingerY - pole.y);
                if (!pole.isCaught && dist < 40) {
                    pole.isCaught = true;
                    score++;
                    scoreDisplay.innerText = score;
                }

                if (!pole.isCaught) {
                    // 落下中
                    pole.y += pole.velY;
                    pole.angle += pole.angVel;
                    if (pole.y > height + 500) resetPole(); // 見逃したら次が降ってくる
                } else {
                    // キャッチ中（指の上での物理）
                    let grav = 0.008;
                    pole.angVel += Math.sin(poleAngleCorrection(pole.angle)) * grav;
                    // 指を動かした時の慣性
                    pole.angVel -= (fingerX - lastFingerX) * 0.002;
                    pole.angVel *= 0.98;
                    pole.angle += pole.angVel;
                    
                    // 棒の位置を指に固定
                    pole.x = fingerX;
                    pole.y = fingerY;

                    // 落下判定（角度がつきすぎたら落としたとみなす）
                    if (Math.abs(poleAngleCorrection(pole.angle)) > Math.PI / 2.1) {
                        pole.isCaught = false;
                        pole.velY = 10; // ストンと落ちる
                    }
                }
            }

            // 棒の描画
            drawPole(pole.x, pole.y, pole.angle);

            // 指先のガイド
            ctx.strokeStyle = '#0ff';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(fingerX, fingerY, 30, 0, Math.PI * 2);
            ctx.stroke();

            lastFingerX = fingerX;
            requestAnimationFrame(draw);
        }

        // 棒を垂直基準で描画するための計算
        function poleAngleCorrection(a) { return a; }

        function drawPole(x, y, angle) {
            const halfLen = pole.length / 2;
            // 棒の端点を計算
            const x1 = x - Math.sin(angle) * 0; // 下端を指の位置に
            const y1 = y + Math.cos(angle) * 0;
            const x2 = x + Math.sin(angle) * pole.length;
            const y2 = y - Math.cos(angle) * pole.length;

            ctx.shadowBlur = 20;
            ctx.shadowColor = pole.isCaught ? '#0f0' : '#f00';
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 12;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x2, y2);
            ctx.stroke();
        }

        draw();
    </script>
</body>
</html>
